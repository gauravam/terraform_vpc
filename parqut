import pandas as pd
from IPython.display import HTML, display
import os

def analyze_parquet_partitions(df, partition_columns):
    """
    Analyze DataFrame partitions for parquet storage and display results in HTML.
    
    Parameters:
    df (pandas.DataFrame): The input DataFrame
    partition_columns (list): List of column names to partition by for parquet storage
    
    Returns:
    HTML: Formatted HTML display of parquet partition analysis
    """
    
    # Validate inputs
    if not isinstance(df, pd.DataFrame):
        raise ValueError("Input must be a pandas DataFrame")
    
    if not isinstance(partition_columns, list):
        partition_columns = [partition_columns]
    
    # Check if all partition columns exist
    missing_cols = [col for col in partition_columns if col not in df.columns]
    if missing_cols:
        raise ValueError(f"Columns not found in DataFrame: {missing_cols}")
    
    # Group by partition columns to simulate parquet partitioning
    grouped = df.groupby(partition_columns)
    partition_info = []
    
    for name, group in grouped:
        if len(partition_columns) == 1:
            partition_path = f"{partition_columns[0]}={name}"
            partition_key = f"{partition_columns[0]}={name}"
        else:
            partition_parts = [f"{col}={val}" for col, val in zip(partition_columns, name)]
            partition_path = "/".join(partition_parts)
            partition_key = ", ".join(partition_parts)
        
        partition_info.append({
            'partition_path': partition_path,
            'partition_key': partition_key,
            'row_count': len(group),
            'memory_usage_mb': group.memory_usage(deep=True).sum() / (1024 * 1024),
            'columns': len(group.columns)
        })
    
    partition_df = pd.DataFrame(partition_info)
    
    # Calculate statistics
    total_partitions = len(partition_df)
    total_rows = len(df)
    avg_partition_size = partition_df['row_count'].mean()
    min_partition_size = partition_df['row_count'].min()
    max_partition_size = partition_df['row_count'].max()
    total_memory_mb = partition_df['memory_usage_mb'].sum()
    avg_memory_per_partition = partition_df['memory_usage_mb'].mean()
    
    # Size distribution
    size_distribution = partition_df['row_count'].value_counts().sort_index()
    
    # Generate partition table HTML
    partition_table_rows = ""
    for _, row in partition_df.head(20).iterrows():  # Show first 20 partitions
        partition_table_rows += f"""
        <tr>
            <td style="padding: 8px; border-bottom: 1px solid #ddd; font-family: monospace; font-size: 12px;">{row['partition_path']}</td>
            <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;">{row['row_count']:,}</td>
            <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;">{row['memory_usage_mb']:.2f} MB</td>
        </tr>
        """
    
    if len(partition_df) > 20:
        partition_table_rows += f"""
        <tr style="background-color: #f8f9fa;">
            <td style="padding: 8px; border-bottom: 1px solid #ddd; font-style: italic;" colspan="3">
                ... and {len(partition_df) - 20} more partitions
            </td>
        </tr>
        """
    
    # Generate size distribution table
    dist_table_rows = ""
    for size, count in size_distribution.head(10).items():
        percentage = (count / total_partitions) * 100
        dist_table_rows += f"""
        <tr>
            <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;">{size:,}</td>
            <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;">{count}</td>
            <td style="padding: 8px; border-bottom: 1px solid #ddd; text-align: right;">{percentage:.1f}%</td>
        </tr>
        """
    
    # Generate HTML
    html_content = f"""
    <div style="font-family: Arial, sans-serif; max-width: 1000px; margin: 20px auto; padding: 20px; border: 2px solid #2c3e50; border-radius: 10px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
        
        <div style="text-align: center; margin-bottom: 30px;">
            <h2 style="color: #2c3e50; margin: 0; font-size: 28px;">üìÅ Parquet Partition Analysis</h2>
            <p style="color: #6c757d; margin: 5px 0 0 0; font-size: 14px;">Partition columns: <strong>{', '.join(partition_columns)}</strong></p>
        </div>
        
        <!-- Summary Statistics -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
            
            <div style="background: #3498db; color: white; padding: 20px; border-radius: 8px; text-align: center;">
                <h3 style="margin: 0 0 10px 0; font-size: 16px;">Total Partitions</h3>
                <p style="margin: 0; font-size: 24px; font-weight: bold;">{total_partitions:,}</p>
            </div>
            
            <div style="background: #27ae60; color: white; padding: 20px; border-radius: 8px; text-align: center;">
                <h3 style="margin: 0 0 10px 0; font-size: 16px;">Total Rows</h3>
                <p style="margin: 0; font-size: 24px; font-weight: bold;">{total_rows:,}</p>
            </div>
            
            <div style="background: #e74c3c; color: white; padding: 20px; border-radius: 8px; text-align: center;">
                <h3 style="margin: 0 0 10px 0; font-size: 16px;">Avg Partition Size</h3>
                <p style="margin: 0; font-size: 24px; font-weight: bold;">{avg_partition_size:.0f}</p>
            </div>
            
            <div style="background: #9b59b6; color: white; padding: 20px; border-radius: 8px; text-align: center;">
                <h3 style="margin: 0 0 10px 0; font-size: 16px;">Total Memory</h3>
                <p style="margin: 0; font-size: 24px; font-weight: bold;">{total_memory_mb:.1f} MB</p>
            </div>
            
        </div>
        
        <!-- Partition Size Range -->
        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6;">
            <h3 style="color: #2c3e50; margin: 0 0 15px 0;">üìä Partition Size Range</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; text-align: center;">
                <div>
                    <p style="margin: 0; color: #6c757d; font-size: 14px;">Minimum</p>
                    <p style="margin: 5px 0 0 0; font-size: 20px; font-weight: bold; color: #28a745;">{min_partition_size:,} rows</p>
                </div>
                <div>
                    <p style="margin: 0; color: #6c757d; font-size: 14px;">Average</p>
                    <p style="margin: 5px 0 0 0; font-size: 20px; font-weight: bold; color: #17a2b8;">{avg_partition_size:.0f} rows</p>
                </div>
                <div>
                    <p style="margin: 0; color: #6c757d; font-size: 14px;">Maximum</p>
                    <p style="margin: 5px 0 0 0; font-size: 20px; font-weight: bold; color: #dc3545;">{max_partition_size:,} rows</p>
                </div>
            </div>
        </div>
        
        <!-- Detailed Partition Information -->
        <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6;">
            <h3 style="color: #2c3e50; margin: 0 0 15px 0;">üìã Partition Details</h3>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 12px 8px; border-bottom: 2px solid #dee2e6; text-align: left; font-weight: bold;">Partition Path</th>
                            <th style="padding: 12px 8px; border-bottom: 2px solid #dee2e6; text-align: right; font-weight: bold;">Row Count</th>
                            <th style="padding: 12px 8px; border-bottom: 2px solid #dee2e6; text-align: right; font-weight: bold;">Memory Usage</th>
                        </tr>
                    </thead>
                    <tbody>
                        {partition_table_rows}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Size Distribution -->
        <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
            <h3 style="color: #2c3e50; margin: 0 0 15px 0;">üìà Partition Size Distribution</h3>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 12px 8px; border-bottom: 2px solid #dee2e6; text-align: right; font-weight: bold;">Partition Size (rows)</th>
                            <th style="padding: 12px 8px; border-bottom: 2px solid #dee2e6; text-align: right; font-weight: bold;">Number of Partitions</th>
                            <th style="padding: 12px 8px; border-bottom: 2px solid #dee2e6; text-align: right; font-weight: bold;">Percentage</th>
                        </tr>
                    </thead>
                    <tbody>
                        {dist_table_rows}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Recommendations -->
        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-top: 20px;">
            <h4 style="color: #856404; margin: 0 0 10px 0;">üí° Parquet Optimization Tips</h4>
            <ul style="color: #856404; margin: 0; padding-left: 20px;">
                <li><strong>Optimal partition size:</strong> 100MB - 1GB per partition file</li>
                <li><strong>Avoid small partitions:</strong> < 1MB partitions can hurt query performance</li>
                <li><strong>Avoid too many partitions:</strong> > 10,000 partitions can slow down metadata operations</li>
                <li><strong>Average memory per partition:</strong> {avg_memory_per_partition:.2f} MB</li>
            </ul>
        </div>
        
    </div>
    """
    
    return HTML(html_content)

# Example usage:
def demo_usage():
    """
    Example of how to use the parquet partition analyzer
    """
    # Create sample data
    import numpy as np
    
    np.random.seed(42)
    sample_data = pd.DataFrame({
        'year': np.random.choice([2020, 2021, 2022, 2023], 1000),
        'month': np.random.choice(range(1, 13), 1000),
        'region': np.random.choice(['North', 'South', 'East', 'West'], 1000),
        'sales': np.random.normal(1000, 200, 1000),
        'quantity': np.random.randint(1, 100, 1000)
    })
    
    # Analyze partitions
    result = analyze_parquet_partitions(sample_data, ['year', 'region'])
    display(result)
    
    print("Function created! Use analyze_parquet_partitions(df, partition_columns) to analyze your DataFrame.")

# Uncomment the line below to run the demo
# demo_usage()
