import pandas as pd
import cx_Oracle
from sqlalchemy import create_engine
from typing import Union, Dict


def oracle_to_pandas(connection: Union[cx_Oracle.Connection, str], schema_name: str, table_name: str) -> pd.DataFrame:
    """
    Read an Oracle table and preserve its schema in a pandas DataFrame using SQLAlchemy.
    
    Args:
        connection: Either a cx_Oracle connection object or a SQLAlchemy connection string
        schema_name: Oracle schema name
        table_name: Oracle table name
        
    Returns:
        pd.DataFrame: Pandas DataFrame with data from the Oracle table with preserved schema
    """
    # Create SQLAlchemy engine if given a cx_Oracle connection
    if isinstance(connection, cx_Oracle.Connection):
        # Setup output type handler for proper date handling
        def output_type_handler(cursor, name, defaultType, size, precision, scale):
            if defaultType == cx_Oracle.DB_TYPE_DATE or defaultType == cx_Oracle.DB_TYPE_TIMESTAMP:
                return cursor.var(cx_Oracle.DB_TYPE_TIMESTAMP, arraysize=cursor.arraysize)
        
        connection.outputtypehandler = output_type_handler
        
        # Create SQLAlchemy engine from existing connection
        engine = create_engine('oracle://', creator=lambda: connection)
    else:
        # Assume it's a connection string
        engine = create_engine(connection)
    
    # Full table name with schema
    full_table_name = f'"{schema_name}"."{table_name}"'
    
    # Use pandas' built-in read_sql function which preserves types well
    df = pd.read_sql_table(table_name, engine, schema=schema_name)
    
    return df


def get_table_schema(connection: Union[cx_Oracle.Connection, str], schema_name: str, table_name: str) -> Dict:
    """
    Get schema information for a specific Oracle table.
    
    Args:
        connection: Either a cx_Oracle connection object or a SQLAlchemy connection string
        schema_name: Oracle schema name
        table_name: Oracle table name
        
    Returns:
        Dict: Dictionary with column information
    """
    # Create SQLAlchemy engine if given a cx_Oracle connection
    if isinstance(connection, cx_Oracle.Connection):
        engine = create_engine('oracle://', creator=lambda: connection)
    else:
        # Assume it's a connection string
        engine = create_engine(connection)
    
    # Use SQLAlchemy's inspect to get table schema
    from sqlalchemy import inspect
    inspector = inspect(engine)
    columns = inspector.get_columns(table_name, schema=schema_name)
    
    # Format into a more readable dictionary
    schema = {}
    for col in columns:
        schema[col['name']] = {
            'type': str(col['type']),
            'nullable': col.get('nullable', True),
            'default': col.get('default')
        }
    
    return schema
