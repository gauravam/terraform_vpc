import pandas as pd
import cx_Oracle
from typing import Dict


def oracle_to_pandas(connection: cx_Oracle.Connection, schema_name: str, table_name: str) -> pd.DataFrame:
    """
    Read an Oracle table and preserve its schema in a pandas DataFrame using pure cx_Oracle.
    
    Args:
        connection: A cx_Oracle connection object
        schema_name: Oracle schema name
        table_name: Oracle table name
        
    Returns:
        pd.DataFrame: Pandas DataFrame with data from the Oracle table with preserved schema
    """
    # Setup output type handler for proper date handling
    def output_type_handler(cursor, name, defaultType, size, precision, scale):
        if defaultType == cx_Oracle.DB_TYPE_DATE or defaultType == cx_Oracle.DB_TYPE_TIMESTAMP:
            return cursor.var(cx_Oracle.DB_TYPE_TIMESTAMP, arraysize=cursor.arraysize)
    
    connection.outputtypehandler = output_type_handler
    
    # Create cursor
    cursor = connection.cursor()
    
    # Get column metadata
    columns_query = """
    SELECT column_name, data_type
    FROM all_tab_columns
    WHERE owner = :schema AND table_name = :table
    ORDER BY column_id
    """
    
    cursor.execute(columns_query, schema=schema_name.upper(), table=table_name.upper())
    columns = cursor.fetchall()
    
    if not columns:
        # If no columns found, maybe try different case
        cursor.execute(columns_query, schema=schema_name, table=table_name)
        columns = cursor.fetchall()
        
        if not columns:
            raise ValueError(f"Table {schema_name}.{table_name} not found. Check schema and table names.")
    
    # Extract column names
    column_names = [col[0] for col in columns]
    
    # Build query
    query = f'SELECT "{schema_name}"."{table_name}"."' + '", "'.join([f'{schema_name}.{table_name}.{col[0]}' for col in columns]) + '" FROM "{schema_name}"."{table_name}"'
    
    # Alternative simpler query if the above has issues
    # query = f'SELECT * FROM "{schema_name}"."{table_name}"'
    
    try:
        # Try to execute the query
        cursor.execute(query)
    except cx_Oracle.DatabaseError:
        # If the specific query fails, try a simpler approach
        query = f'SELECT * FROM "{schema_name}"."{table_name}"'
        try:
            cursor.execute(query)
        except cx_Oracle.DatabaseError:
            # Try without quotes
            query = f'SELECT * FROM {schema_name}.{table_name}'
            cursor.execute(query)
    
    # Fetch all rows
    rows = cursor.fetchall()
    
    # Create DataFrame
    df = pd.DataFrame(rows, columns=column_names)
    
    # Close cursor
    cursor.close()
    
    return df


def get_table_schema(connection: cx_Oracle.Connection, schema_name: str, table_name: str) -> Dict:
    """
    Get schema information for a specific Oracle table.
    
    Args:
        connection: A cx_Oracle connection object
        schema_name: Oracle schema name
        table_name: Oracle table name
        
    Returns:
        Dict: Dictionary with column information
    """
    cursor = connection.cursor()
    
    query = """
    SELECT column_name, data_type, data_length, data_precision, data_scale, nullable
    FROM all_tab_columns
    WHERE owner = :schema AND table_name = :table
    ORDER BY column_id
    """
    
    cursor.execute(query, schema=schema_name.upper(), table=table_name.upper())
    columns = cursor.fetchall()
    
    if not columns:
        # Try with different case
        cursor.execute(query, schema=schema_name, table=table_name)
        columns = cursor.fetchall()
        
        if not columns:
            raise ValueError(f"Table {schema_name}.{table_name} not found. Check schema and table names.")
    
    schema = {}
    for col in columns:
        col_name = col[0]
        col_type = col[1]
        length = col[2]
        precision = col[3]
        scale = col[4]
        nullable = col[5]
        
        type_desc = col_type
        if col_type == 'NUMBER' and precision is not None:
            if scale == 0:
                type_desc = f'NUMBER({precision})'
            else:
                type_desc = f'NUMBER({precision},{scale})'
        elif col_type in ('VARCHAR2', 'NVARCHAR2', 'CHAR', 'NCHAR'):
            type_desc = f'{col_type}({length})'
        
        schema[col_name] = {
            'type': type_desc,
            'nullable': nullable == 'Y'
        }
    
    cursor.close()
    return schema
